<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CerediraTess - исполнитель задач</title>

    <link rel="stylesheet" type="text/css" href="public/bootstrap.min.css">
    <script src="public/jquery-3.5.1.min.js"></script>
    <script src="public/bootstrap.bundle.min.js"></script>

    <style>
        body {
            font-family: serif;
        }
        textarea {
            font-family: monospace;
        }
        .ct-table-row-success {
            background-color: aliceblue;
        }
        .ct-table-row-error {
            background-color: mistyrose;
        }

        .ct-response-check-success {
            color: green;
        }
        .ct-response-check-error {
            color: red;
        }
    </style>

    <script type="text/javascript">
        var ctHost = window.location.origin;
        var scriptsMeta = {};

        function getAuth() {
            return btoa($("#username")[0].value + ":" + $("#password")[0].value)
        };

        function uuidv4() {
            return 'Rxxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        function getCurrentDateTime() {
            var currentdate = new Date();
            return currentdate.getFullYear() + "."
                + (currentdate.getMonth()+1)  + "."
                + currentdate.getDate() + " "
                + currentdate.getHours() + ":"
                + currentdate.getMinutes() + ":"
                + currentdate.getSeconds();
        };

        function getCTResponseBlock(parentId, agents, executedScript){
            var uid = uuidv4();
            var headerUid = uuidv4();

            var table = `<table class="table table-bordered">
                <thead>
                    <tr class="d-flex">
                        <th class="col-1">#</th>
                        <th class="col-2">Агент</th>
                        <th class="col-1">Статус</th>
                        <th class="col-7">Результат</th>
                        <th class="col-1">Проверка</th>
                    <tr>
                </thead>
                <tbody>
            `;

            var agentsNumbering = 1;
            var agentsResultRows = {};
            for (var agent of agents) {
                var rowUID = uuidv4();
                agentsResultRows[agent] = rowUID;
                table += `<tr class="d-flex" id=${rowUID}>
                    <td class="col-sm-1">${agentsNumbering}</td>
                    <td class="col-sm-2">${agent}</td>
                    <td class="col-sm-1"><div class="spinner-border" role="status"></div></td>
                    <td class="col-sm-7"><textarea class="form-control" rows="5"></textarea></td>
                    <td class="col-sm-1"></td>
                </tr>
                `;
                agentsNumbering++;
            }

            table += `
                </tbody>
            </table>
            `;

            var htmlRequestBlock = `<div class="card">
                    <div class="card-header" id="${headerUid}">
                        <h5 class="mb-0">
                            <button class="btn btn btn-secondary" type="button" data-toggle="collapse" data-target="#${uid}"
                                    aria-expanded="true" aria-controls="${uid}">
                                Свернуть/развернуть
                            </button>
                            <button class="btn btn-danger" type="button" onclick="$(this).closest('.card').remove();">Удалить</button>
                            <label>Результат выполнения скрипта (${getCurrentDateTime()}): ${executedScript}</label>
                        </h5>
                    </div>

                    <div id="${uid}" class="collapse show" aria-labelledby="${headerUid}">
                        <div class="card-body">
                            ${table}
                        </div>
                    </div>
                </div>
            `;

            return { "tableHTML" : htmlRequestBlock, "agentsResultRows": agentsResultRows };
        };

        function setAgentRowResult(agentResultRowId, status, data, result, executionCheck) {
            var agentRow = $("#" + agentResultRowId);

            if (agentRow.length) {
                if (result == 'success') {
                    agentRow.addClass('ct-table-row-success');
                } else if (result == 'error') {
                    agentRow.addClass('ct-table-row-error');
                }
                $(agentRow.children()[3].children[0]).val(data);
                agentRow.children()[2].innerHTML = getCurrentDateTime() + ": " + status;

                var responseCheckingResult = true;
                for (var logicalAnd of executionCheck) {
                    var logicalOrResult = false;

                    for (var logicalOr of logicalAnd) {
                        var regex = new RegExp(logicalOr, "i");
                        if (regex.test(data)) {
                            logicalOrResult = true;
                            break;
                        }
                    }
                    responseCheckingResult = responseCheckingResult && logicalOrResult;
                }

                if (responseCheckingResult) {
                    $(agentRow.children()[4]).addClass('ct-response-check-success');
                    $(agentRow.children()[4]).html('SUCCESS');
                } else {
                    $(agentRow.children()[4]).addClass('ct-response-check-error');
                    $(agentRow.children()[4]).html('FAILED');
                }
            }
        }

        function executeScript(agentsResultRows, auth, scriptName, body) {
            for (let agent in agentsResultRows) {
                let agentResultRowId = agentsResultRows[agent];
                $.ajax({
                    url: `executeScript/${scriptName}`,
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: body.replace("{hostname}", agent),
                    cache: false,
                    beforeSend: function (xhr) {
                        /* Authorization header */
                        xhr.setRequestHeader("Authorization", auth);
                    },
                    success: function (data, status) {
                        setAgentRowResult(agentResultRowId, status, data, 'success', scriptsMeta[scriptName]['executionCheck']);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        setAgentRowResult(agentResultRowId, jqXHR.status, jqXHR.responseText, 'error', scriptsMeta[scriptName]['executionCheck']);
                    }
                });
            }
        };

        function addCTHistoryBlock() {
            var requestDict = getCTResponseBlock("#CTRequestsHistory", $("#ctAgents").val(), $("#ctScripts").val());
            $("#CTRequestsHistory").prepend(requestDict["tableHTML"]);
            executeScript(requestDict["agentsResultRows"], getAuth(), $("#ctScripts").val(), $("#ctRequestBody").val());
        };

        $(document).ready(function(){
            $("#executeCTRequest").click(function(){
                addCTHistoryBlock();
            });

            $("#ctScripts").change(function(){
                var ctAgents = $("#ctAgents")[0];
                ctAgents.innerHTML = '<option value="" selected disabled>Выберите агент или агенты</option>';

                for (var agent of scriptsMeta[this.value]['agents']) {
                    var op = document.createElement("option");
                    op.setAttribute("value", agent);
                    op.text = agent;
                    ctAgents.append(op);
                }

                reqBody = {};
                reqBody.hostname = '{hostname}';
                reqBody.args = scriptsMeta[this.value]['arguments'];

                $("#ctRequestBody")[0].value = JSON.stringify(reqBody, null, 4);
            });

            $("#updateCT").click(function(){
                $.ajax({
                    url: "getAvailableScripts",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: "",
                    cache: false,
                    beforeSend: function (xhr) {
                        /* Authorization header */
                        xhr.setRequestHeader("Authorization", getAuth());
                    },
                    success: function (data, status) {
                        // alert("Data: " + data + "\nStatus: " + status);
                        scriptsMeta = JSON.parse(data);

                        var ctScripts = $("#ctScripts")[0];
                        ctScripts.innerHTML = '<option value="" selected disabled>Выберите скрипт для выполнения</option>';

                        for (var key in scriptsMeta) {
                            var op = document.createElement("option");
                            op.setAttribute("value", key);
                            op.text = key + ': ' + scriptsMeta[key].description;
                            ctScripts.append(op);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert( jqXHR.responseText );
                    }
                });
            });
        });
    </script>
</head>
<body>
<div class="conteiner">
    <div class="row">
        <div class="col text-center">
            <h1><b>Выполнение запросов к CerediraTess</b></h1>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Авторизация</span>
                </div>

                <div class="input-group-prepend">
                    <span class="input-group-text">Логин</span>
                </div>
                <input type="text" class="form-control" placeholder="Введите логин" id="username">

                <div class="input-group-prepend">
                    <span class="input-group-text">Пароль</span>
                </div>
                <input type="password" class="form-control" placeholder="Введите пароль" id="password">

                <input type="button" class="btn btn-primary" value="Обновить CerediraTess" id="updateCT">
            </div>
        </div>
        <div class="col">
        </div>
    </div>
    <div class="row">
        <div class="col text-center">
            <h2><b>Формирование запроса</b></h2>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Скрипт</span>
                </div>
                <select class='custom-select' placeholder="Выберите скрипт" id="ctScripts">
                    <option value="" selected disabled>Авторизуйтесь, для получения доступных скриптов</option>
                </select>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Агенты</span>
                </div>
                <select class='custom-select' multiple placeholder="Выберите агент или агенты" id="ctAgents">
                    <option value="" selected disabled>Выберите скрипт, для получения доступных агентов</option>
                </select>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Тело запроса</span>
                </div>
                <textarea class="form-control" rows="8" id="ctRequestBody"></textarea>
            </div>
            <div class="input-group mb-3">
                <button type="button" class="btn btn-success btn-block" id="executeCTRequest">Выполнить запрос</button>
            </div>
        </div>
        <div class="col">
        </div>
    </div>
    <div class="row">
        <div class="col text-center">
            <h2><b>История запросов</b></h2>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="accordion" id="CTRequestsHistory"></div>
        </div>
        <div class="col">
        </div>
    </div>
</div>
</body>
</html>