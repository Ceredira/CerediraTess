<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CerediraTess - исполнитель задач</title>
    <link rel="stylesheet" type="text/css" href="public/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="public/fontawesome-free-5.13.0-web/css/all.min.css">
    <script src="public/jquery-3.5.1.min.js"></script>
    <script src="public/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
        var ctHost = window.location.origin;
        var scriptsMeta = {};

        function getAuth() {
            return btoa($("#username")[0].value + ":" + $("#password")[0].value)
        };

        function uuidv4() {
            return 'Rxxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getCTResponseBlock(parentId, agents){
            var uid = uuidv4();
            var headerUid = uuidv4();

            var table = `<table class="table table-bordered">
                <thead>
                    <tr class="d-flex">
                        <th class="col-1">#</th>
                        <th class="col-2">Агент</th>
                        <th class="col-1">Статус</th>
                        <th class="col-7">Результат</th>
                        <th class="col-1">Проверка</th>
                    <tr>
                </thead>
                <tbody>
            `;

            var agentsNumbering = 1;
            var agentsResultRows = {};
            for (var agent of agents) {
                var rowUID = uuidv4();
                agentsResultRows[agent] = rowUID;
                table += `<tr class="d-flex" id=${rowUID}>
                    <td class="col-sm-1">${agentsNumbering}</td>
                    <td class="col-sm-2">${agent}</td>
                    <td class="col-sm-1"><div class="spinner-border" role="status"></div></td>
                    <td class="col-sm-7"><textarea class="form-control" rows="5"></textarea></td>
                    <td class="col-sm-1"></td>
                </tr>
                `;
                agentsNumbering++;
            }

            table += `
                </tbody>
            </table>
            `;

            var htmlRequestBlock = `<div class="card">
                    <div class="card-header" id="${headerUid}">
                        <h5 class="mb-0">
                            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#${uid}"
                                    aria-expanded="true" aria-controls="${uid}">
                                Разворачиваемая панель ${uid}
                            </button>
                            <button class="btn" type="button">Удалить
                            </button>
                        </h5>
                    </div>

                    <div id="${uid}" class="collapse show" aria-labelledby="${headerUid}">
                        <div class="card-body">
                            ${table}
                        </div>
                    </div>
                </div>
            `;

            return { "tableHTML" : htmlRequestBlock, "agentsResultRows": agentsResultRows };
        };

        function executeScript(agentsResultRows, auth, scriptName, body) {
            for (let agent in agentsResultRows) {
                let ffff = agentsResultRows[agent];
                $.ajax({
                    url: `executeScript/${scriptName}`,
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: body.replace("{hostname}", agent),
                    cache: false,
                    beforeSend: function (xhr) {
                        /* Authorization header */
                        xhr.setRequestHeader("Authorization", auth);
                    },
                    success: function (data, status) {
                        $($("#" + ffff).children()[3].children[0]).val(data);
                        $("#" + ffff).children()[2].innerHTML = status;
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $($("#" + ffff).children()[3].children[0]).val(jqXHR.responseText);
                        $("#" + ffff).children()[2].innerHTML = jqXHR.status;
                    }
                });
            }
        };

        function addCTHistoryBlock() {
            var requestDict = getCTResponseBlock("#CTRequestsHistory", $("#ctAgents").val());
            $("#CTRequestsHistory").prepend(requestDict["tableHTML"]);
            executeScript(requestDict["agentsResultRows"], getAuth(), $("#ctScripts").val(), $("#ctRequestBody").val());
        };

        $(document).ready(function(){
            $("#executeCTRequest").click(function(){
                addCTHistoryBlock();
            });

            $("#ctScripts").change(function(){
                var ctAgents = $("#ctAgents")[0];
                ctAgents.innerHTML = '';

                for (var agent of scriptsMeta[this.value]['agents']) {
                    var op = document.createElement("option");
                    op.setAttribute("value", agent);
                    op.text = agent;
                    ctAgents.append(op);
                }

                reqBody = {};
                reqBody.hostname = '{hostname}';
                reqBody.args = scriptsMeta[this.value]['arguments'];

                $("#ctRequestBody")[0].value = JSON.stringify(reqBody, null, 4);
            });

            $("#updateCT").click(function(){
                $.ajax({
                    url: "getAvailableScripts",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: "",
                    cache: false,
                    beforeSend: function (xhr) {
                        /* Authorization header */
                        xhr.setRequestHeader("Authorization", getAuth());
                    },
                    success: function (data, status) {
                        // alert("Data: " + data + "\nStatus: " + status);
                        scriptsMeta = JSON.parse(data);

                        var ctScripts = $("#ctScripts")[0];
                        ctScripts.innerHTML = '';

                        for (var key in scriptsMeta) {
                            var op = document.createElement("option");
                            op.setAttribute("value", key);
                            op.text = key + ': ' + scriptsMeta[key].description;
                            ctScripts.append(op);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert( jqXHR.responseText );
                    }
                });
            });
        });
    </script>
</head>
<body>
<div class="conteiner">
    <div class="row">
        <div class="col text-center">
            <h1>Выполнение запросов к CerediraTess</h1>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Авторизация</span>
                </div>

                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input type="text" class="form-control" placeholder="Логин" id="username">

                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                <input type="password" class="form-control" placeholder="Пароль" id="password">

                <input type="button" class="btn btn-primary" value="Обновить CerediraTess" id="updateCT">
            </div>
        </div>
        <div class="col">
        </div>
    </div>
    <div class="row">
        <div class="col text-center">
            <h2>Формирование запроса</h2>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Скрипт</span>
                </div>
                <select class='custom-select' placeholder="Выберите скрипт" id="ctScripts"></select>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Агенты</span>
                </div>
                <select class='custom-select' multiple placeholder="Выберите агент или агенты" id="ctAgents"></select>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Тело запроса</span>
                </div>
                <textarea class="form-control" rows="8" id="ctRequestBody"></textarea>
            </div>
            <div class="input-group mb-3">
                <button type="button" class="btn btn-success btn-block" id="executeCTRequest">Выполнить запрос</button>
            </div>
        </div>
        <div class="col">
        </div>
    </div>
    <div class="row">
        <div class="col text-center">
            <h2>История запросов</h2>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="accordion" id="CTRequestsHistory"></div>
        </div>
        <div class="col">
        </div>
    </div>
</div>
</body>
</html>