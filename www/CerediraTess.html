<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CerediraTess - исполнитель задач</title>

    <link rel="stylesheet" type="text/css" href="public/bootstrap.min.css">
    <script src="public/jquery-3.5.1.min.js"></script>
    <script src="public/bootstrap.bundle.min.js"></script>

    <style>
        body {
            font-family: serif;
        }
        .ctRequestBody {
            /*font-family: monospace;*/
        }
        .ct-table-row-success {
            background-color: aliceblue;
        }
        .ct-table-row-error {
            background-color: mistyrose;
        }

        .ct-response-check-success {
            color: green;
        }
        .ct-response-check-error {
            color: red;
        }
        .width-fit-content {
            max-width: fit-content;
        }
    </style>

    <script type="text/javascript">
        var ctHost = window.location.origin;
        var scriptsMeta = {};

        function showError(label, body) {
            $('#errorModalLabel').html(label);
            $('#errorModalBody').html(body);
            $('#errorModal').modal({show: true});
        };

        function getAuth() {
            return btoa($("#username").val() + ":" + $("#password").val());
        };

        function uuidv4() {
            return 'Rxxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        function getCurrentDateTime() {
            var currentdate = new Date();
            return currentdate.getFullYear() + "."
                + (currentdate.getMonth()+1)  + "."
                + currentdate.getDate() + " "
                + currentdate.getHours() + ":"
                + currentdate.getMinutes() + ":"
                + currentdate.getSeconds();
        };

        function getCTResponseBlock(parentId, agents, executedScript, executedScriptBody){
            var uid = uuidv4();
            var headerUid = uuidv4();

            var table = `<table class="table table-bordered">
                <thead>
                    <tr class="d-flex">
                        <th class="col-1">#</th>
                        <th class="col-2">Агент</th>
                        <th class="col-1">Статус</th>
                        <th class="col-7">Результат</th>
                        <th class="col-1">Проверка</th>
                    <tr>
                </thead>
                <tbody>
            `;

            var agentsNumbering = 1;
            var agentsResultRows = {};
            for (var agent of agents) {
                var rowUID = uuidv4();
                agentsResultRows[agent] = rowUID;
                table += `<tr class="d-flex" id=${rowUID}>
                    <td class="col-sm-1">${agentsNumbering}</td>
                    <td class="col-sm-2">${agent}</td>
                    <td class="col-sm-1"><div class="spinner-border" role="status"></div></td>
                    <td class="col-sm-7"><textarea class="form-control" rows="5"></textarea></td>
                    <td class="col-sm-1"></td>
                </tr>
                `;
                agentsNumbering++;
            }

            table += `
                </tbody>
            </table>
            `;

            var htmlRequestBlock = `<div class="card">
                    <div class="card-header" id="${headerUid}">
                        <h5 class="mb-0">
                            <button class="btn btn btn-secondary btn-sm" type="button" data-toggle="collapse" data-target="#${uid}"
                                    aria-expanded="true" aria-controls="${uid}">
                                Свернуть/развернуть
                            </button>
                            <button class="btn btn-danger btn-sm" type="button" onclick="$(this).closest('.card').remove();">Удалить</button>
                            <input type="hidden" value="${btoa(executedScript)}">
                            <input type="hidden" value="${btoa(executedScriptBody)}">
                            <button class="btn btn-primary btn-sm" type="button" onclick="useCurrentRequest(this)">Использовать</button>
                            <label>Результат выполнения скрипта (${getCurrentDateTime()}): ${executedScript}</label>
                        </h5>
                    </div>

                    <div id="${uid}" class="collapse show" aria-labelledby="${headerUid}">
                        <div class="card-body">
                            ${table}
                        </div>
                    </div>
                </div>
            `;

            return { "tableHTML" : htmlRequestBlock, "agentsResultRows": agentsResultRows };
        };

        function useCurrentRequest(useButton) {
            $('#ctRequestBody').val(atob($(useButton).prev().attr('value')));
            $('#ctScripts').val(atob($(useButton).prev().prev().attr('value')));
        };

        function setAgentRowResult(agentResultRowId, status, data, result, executionCheck) {
            var agentRow = $("#" + agentResultRowId);

            if (agentRow.length) {
                if (result == 'success') {
                    agentRow.addClass('ct-table-row-success');
                } else if (result == 'error') {
                    agentRow.addClass('ct-table-row-error');
                }
                $(agentRow.children()[3].children[0]).val(data);
                agentRow.children()[2].innerHTML = getCurrentDateTime() + ": " + status;

                var responseCheckingResult = true;
                for (var logicalAnd of executionCheck) {
                    var logicalOrResult = false;

                    for (var logicalOr of logicalAnd) {
                        var regex = new RegExp(logicalOr, "i");
                        if (regex.test(data)) {
                            logicalOrResult = true;
                            break;
                        }
                    }
                    responseCheckingResult = responseCheckingResult && logicalOrResult;
                }

                if (responseCheckingResult) {
                    $(agentRow.children()[4]).addClass('ct-response-check-success');
                    $(agentRow.children()[4]).html('SUCCESS');
                } else {
                    $(agentRow.children()[4]).addClass('ct-response-check-error');
                    $(agentRow.children()[4]).html('FAILED');
                }
            }
        };



        function checkRequestBody() {
            try {
                JSON.parse($("#ctRequestBody").val());
                return true;
            } catch(e) {
                showError('Ошибка валидации тела запроса', e.toString());
                return false;
            }
        };

        function checkAgentsSelected() {
            if ($("#ctAgents").val() !== null && $("#ctAgents").val().length !== 0) {
                return true;
            } else {
                showError('Ошибка выполнения запроса', 'Не выбраны агент/агенты для выполнения запроса');
                return false;
            }
        };

        function checkScriptSelected() {
            if ($("#ctScripts").val() !== null && $("#ctScripts").val() !== "") {
                return true;
            } else {
                showError('Ошибка выполнения запроса', 'Не выбран скрипт для выполнения запроса');
                return false;
            }
        };

        function executeScript(agentsResultRows, auth, scriptName, body) {
            for (let agent in agentsResultRows) {
                let agentResultRowId = agentsResultRows[agent];
                $.ajax({
                    url: `executeScript/${scriptName}`,
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: body.replace("{hostname}", agent),
                    cache: false,
                    beforeSend: function (xhr) {
                        /* Authorization header */
                        xhr.setRequestHeader("Authorization", auth);
                    },
                    success: function (data, status) {
                        setAgentRowResult(agentResultRowId, status, data, 'success', scriptsMeta[scriptName]['executionCheck']);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        setAgentRowResult(agentResultRowId, jqXHR.status, jqXHR.responseText, 'error', scriptsMeta[scriptName]['executionCheck']);
                    }
                });
            }
        };

        function addCTHistoryBlock() {
            var requestDict = getCTResponseBlock("#CTRequestsHistory", $("#ctAgents").val(), $("#ctScripts").val(), $("#ctRequestBody").val());
            $("#CTRequestsHistory").prepend(requestDict["tableHTML"]);
            executeScript(requestDict["agentsResultRows"], getAuth(), $("#ctScripts").val(), $("#ctRequestBody").val());
        };

        function setParamInRequestBody(param, value) {
            var obj = JSON.parse($('#ctRequestBody').val());
            if (value !== null && value !== "") {
                obj[param] = value;
            } else {
                delete obj[param];
            }
            $('#ctRequestBody').val(JSON.stringify(obj, null, 4));
        };

        $(document).ready(function(){
            $("#ctScripts").change(function(){
                var ctAgents = $("#ctAgents");
                ctAgents.html('<option value="" selected disabled>Выберите агент или агенты</option>');

                for (var agent of scriptsMeta[this.value]['agents']) {
                    var op = document.createElement("option");
                    op.setAttribute("value", agent);
                    op.text = agent;
                    ctAgents.append(op);
                }

                reqBody = {};
                reqBody.hostname = '{hostname}';
                reqBody.args = scriptsMeta[this.value]['arguments'];
                if (scriptsMeta[this.value]['recommendedEncoding'] !== undefined) {
                    reqBody.encoding = scriptsMeta[this.value]['recommendedEncoding'];
                }

                $("#ctRequestBody").val(JSON.stringify(reqBody, null, 4));
            });

            $("#updateCT").click(function(){
                $.ajax({
                    url: "getAvailableScripts",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: "",
                    cache: false,
                    beforeSend: function (xhr) {
                        /* Authorization header */
                        xhr.setRequestHeader("Authorization", getAuth());
                    },
                    success: function (data, status) {
                        // alert("Data: " + data + "\nStatus: " + status);
                        scriptsMeta = JSON.parse(data);

                        var ctScripts = $("#ctScripts");
                        ctScripts.html('<option value="" selected disabled>Выберите скрипт для выполнения</option>');

                        for (var key in scriptsMeta) {
                            var op = document.createElement("option");
                            op.setAttribute("value", key);
                            op.text = key + ': ' + scriptsMeta[key].description;
                            ctScripts.append(op);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert( jqXHR.responseText );
                    }
                });
            });

            $("#executeCTRequest").click(function(){
                if (checkScriptSelected() === true) {
                    if (checkAgentsSelected() === true) {
                        if (checkRequestBody() === true) {
                            addCTHistoryBlock();
                        }
                    }
                }
            });

            $("#setEncodingParam").change(function(){
                var value = $(this).val();
                setParamInRequestBody('encoding', value);
            });

            $("#setTimeoutParam").change(function(){
                var value = $(this).val();
                setParamInRequestBody('timeout', value);
            });

            $("#setCredsParam").change(function(){
                var value = $(this).val();
                setParamInRequestBody('creds', value);
            });

            $("#requestParametersDescription").click(function(){
                var script = $("#ctScripts").val();
                if (script) {
                    var argNumber = 1;
                    var htmlTable = `<label>${scriptsMeta[script]['description']}</label><table class="table">`;
                    for (var argDesc of scriptsMeta[script]['argumentsDescription']) {
                        htmlTable += `<tr><td rowspan="2">${argNumber}</td><td>${scriptsMeta[script]['arguments'][argNumber - 1]}</td></tr>
                        <tr><td>${argDesc}</td></tr>`;
                        argNumber += 1;
                    }
                    htmlTable += '</table>';

                    $('#errorModalLabel').html('Описание параметров ' + script);
                    $('#errorModalBody').html(htmlTable);
                    $('#errorModal').modal({show: true});
                }
            });

            $("#requestValidation").click(function(){
                checkRequestBody();
            });
        });
    </script>
</head>
<body>
<div class="conteiner">
    <div class="row">
        <div class="col text-center">
            <h1><b>Выполнение запросов к CerediraTess</b></h1>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Авторизация</span>
                </div>

                <div class="input-group-prepend">
                    <span class="input-group-text">Логин</span>
                </div>
                <input type="text" class="form-control" placeholder="Введите логин" id="username">

                <div class="input-group-prepend">
                    <span class="input-group-text">Пароль</span>
                </div>
                <input type="password" class="form-control" placeholder="Введите пароль" id="password">

                <input type="button" class="btn btn-primary btn-sm" value="Обновить CerediraTess" id="updateCT">
            </div>
        </div>
        <div class="col">
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Скрипт</span>
                </div>
                <select class='custom-select' id="ctScripts">
                    <option value="" selected disabled>Авторизуйтесь, для получения доступных скриптов</option>
                </select>
            </div>
            <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Агенты</span>
                </div>
                <select class='custom-select width-fit-content' multiple id="ctAgents">
                    <option value="" selected disabled>Выберите скрипт, для получения доступных агентов</option>
                </select>
                <div class="input-group-prepend">
                    <span class="input-group-text">Тело запроса</span>
                </div>
                <textarea class="form-control ctRequestBody" rows="8" id="ctRequestBody">{&#13;&#10;}</textarea>
                <table>
                    <tr>
                        <td>
                            <select class='custom-select custom-select-sm' id="setEncodingParam">
                                <option value="" selected>Выберите кодировку</option>
                                <option value="utf-8">utf-8</option>
                                <option value="866">866</option>
                                <option value="1251">1251</option>
                                <option value="1252">1252</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <select class='custom-select custom-select-sm' id="setCredsParam">
                                <option value="" selected>Выберите авторизационные данные</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="number" class="form-control form-control-sm" min="1" max="1000000"
                                   placeholder="Таймаут секунд" id="setTimeoutParam">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button type="button" class="btn btn-primary btn-block btn-sm"
                                    id="requestParametersDescription">Описание параметров</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button type="button" class="btn btn-primary btn-block btn-sm" id="requestValidation">
                                Валидация запроса
                            </button>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="input-group mb-3">

            </div>
            <div class="input-group input-group-sm mb-3">
                <button type="button" class="btn btn-success btn-block btn-sm" id="executeCTRequest">Выполнить запрос</button>
            </div>
        </div>
        <div class="col">
        </div>
    </div>
    <div class="row">
        <div class="col text-center">
            <h2><b>История запросов</b></h2>
        </div>
    </div>
    <div class="row">
        <div class="col">
        </div>
        <div class="col-10">
            <div class="accordion" id="CTRequestsHistory"></div>
        </div>
        <div class="col">
        </div>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Заголовок</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Ok">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="errorModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>